{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="container mt-5">
    <h1 class="text-center mb-4">Project Dashboard</h1>

    <div class="card shadow-lg mb-4">
        <div class="card-body">
            <form id="filter-form" class="row mb-3">
                <div class="col-md-3 mb-2">
                    <label for="project-name" class="form-label">Project Name:</label>
                    <select id="project-name" name="project_name" class="form-select">
                        <option value="">All Projects</option>
                        <!-- Project options will be dynamically populated -->
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label for="supported-transactions" class="form-label">Supported Transactions:</label>
                    <input type="number" id="supported-transactions" name="supported_transactions" class="form-control"
                        placeholder="Enter # of Transactions">
                </div>
                <div class="col-md-3 mb-2">
                    <label for="supported-value" class="form-label">Supported Value:</label>
                    <input type="number" id="supported-value" name="supported_value" class="form-control"
                        placeholder="Enter Total Value">
                </div>
                <div class="col-md-3 mb-2">
                    <label for="unsupported-transactions" class="form-label">Unsupported Transactions:</label>
                    <input type="number" id="unsupported-transactions" name="unsupported_transactions"
                        class="form-control" placeholder="Enter # of Transactions">
                </div>
                <div class="col-md-3 mb-2">
                    <label for="unsupported-value" class="form-label">Unsupported Value:</label>
                    <input type="number" id="unsupported-value" name="unsupported_value" class="form-control"
                        placeholder="Enter Total Value">
                </div>
                <div class="col-md-12 mt-2">
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <button type="button" class="btn btn-secondary ms-2" id="reset-button">Reset</button>
                </div>
            </form>

            <div id="summary-section" class="alert alert-info mb-4" role="alert">
                <!-- Summary information will be displayed here -->
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover" id="project-table">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Supported Transactions</th>
                            <th>Supported Value</th>
                            <th>Unsupported Transactions</th>
                            <th>Unsupported Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td>
                                <a href="{% url 'transactions:project_dashboard' project.project_name %}" class="btn btn-link text-decoration-none">
                                    {{ project.project_name }}
                                </a>
                            </td>
                            <td>{{ project.supported_transactions_number }}</td>
                            <td>{{ project.supported_transactions_value|intcomma }}</td>
                            <td>{{ project.unsupported_transactions_number }}</td>
                            <td>{{ project.unsupported_transactions_value|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Populate project dropdown
        populateProjectDropdown();
        
        // Set up event listeners
        document.getElementById('filter-form').addEventListener('submit', filterProjects);
        document.getElementById('reset-button').addEventListener('click', resetFilters);
        
        // Initial summary update
        updateSummary();
    });
    
    function populateProjectDropdown() {
        const projectDropdown = document.getElementById('project-name');
        const projectNames = [...new Set(Array.from(document.querySelectorAll('#project-table tbody tr td:first-child a')).map(a => a.textContent.trim()))];
        
        projectNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            projectDropdown.appendChild(option);
        });
    }
    
    function filterProjects(e) {
        e.preventDefault();
        
        const projectName = document.getElementById('project-name').value.toLowerCase();
        const supportedTransactions = document.getElementById('supported-transactions').value;
        const supportedValue = document.getElementById('supported-value').value;
        const unsupportedTransactions = document.getElementById('unsupported-transactions').value;
        const unsupportedValue = document.getElementById('unsupported-value').value;
        
        const rows = document.querySelectorAll('#project-table tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowProjectName = cells[0].textContent.trim().toLowerCase();
            const rowSupportedTransactions = parseInt(cells[1].textContent.replace(/,/g, '')) || 0;
            const rowSupportedValue = parseInt(cells[2].textContent.replace(/,/g, '')) || 0;
            const rowUnsupportedTransactions = parseInt(cells[3].textContent.replace(/,/g, '')) || 0;
            const rowUnsupportedValue = parseInt(cells[4].textContent.replace(/,/g, '')) || 0;
            
            let visible = true;
            
            if (projectName && !rowProjectName.includes(projectName)) {
                visible = false;
            }
            
            if (supportedTransactions && rowSupportedTransactions < parseInt(supportedTransactions)) {
                visible = false;
            }
            
            if (supportedValue && rowSupportedValue < parseInt(supportedValue)) {
                visible = false;
            }
            
            if (unsupportedTransactions && rowUnsupportedTransactions < parseInt(unsupportedTransactions)) {
                visible = false;
            }
            
            if (unsupportedValue && rowUnsupportedValue < parseInt(unsupportedValue)) {
                visible = false;
            }
            
            row.style.display = visible ? '' : 'none';
        });
        
        updateSummary();
    }
    
    function resetFilters() {
        document.getElementById('filter-form').reset();
        
        const rows = document.querySelectorAll('#project-table tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        
        updateSummary();
    }
    
    function updateSummary() {
        const visibleRows = Array.from(document.querySelectorAll('#project-table tbody tr')).filter(row => row.style.display !== 'none');
        
        let totalSupportedTransactions = 0;
        let totalSupportedValue = 0;
        let totalUnsupportedTransactions = 0;
        let totalUnsupportedValue = 0;
        
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            totalSupportedTransactions += parseInt(cells[1].textContent.replace(/,/g, '')) || 0;
            totalSupportedValue += parseInt(cells[2].textContent.replace(/,/g, '')) || 0;
            totalUnsupportedTransactions += parseInt(cells[3].textContent.replace(/,/g, '')) || 0;
            totalUnsupportedValue += parseInt(cells[4].textContent.replace(/,/g, '')) || 0;
        });
        
        const summarySection = document.getElementById('summary-section');
        summarySection.innerHTML = `
            <strong>Summary:</strong> Showing ${visibleRows.length} projects | 
            Total Supported Transactions: ${totalSupportedTransactions.toLocaleString()} |
            Total Supported Value: ${totalSupportedValue.toLocaleString()} |
            Total Unsupported Transactions: ${totalUnsupportedTransactions.toLocaleString()} |
            Total Unsupported Value: ${totalUnsupportedValue.toLocaleString()}
        `;
    }
</script>
{% endblock %}