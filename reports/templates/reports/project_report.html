{% extends "reports/base.html" %}
{% load static %}
{% load report_filters %}
{% block title %}{{ project.project_name }} Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reports/css/report.css' %}">
<style>
/* Enhanced Filter Styles */
.filter-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
}

.filter-title {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 1.1em;
    font-weight: 600;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9em;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    background-color: white;
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.filter-actions {
    display: flex;
    gap: 10px;
}

.btn-filter, .btn-reset, .btn-export {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.btn-filter {
    background-color: #007bff;
    color: white;
}

.btn-filter:hover {
    background-color: #0056b3;
}

.btn-reset {
    background-color: #6c757d;
    color: white;
}

.btn-reset:hover {
    background-color: #545b62;
}

.btn-export {
    background-color: #28a745;
    color: white;
}

.btn-export:hover {
    background-color: #1e7e34;
}

/* Enhanced Table Styles */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.data-table th {
    background-color: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
    text-align: center;
    min-width: 80px;
}

.status-badge.supported {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-badge.unsupported {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.amount-cell {
    text-align: right;
    font-family: monospace;
    font-weight: 500;
}

.comment-preview {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    color: #6c757d;
}

.comment-preview:hover {
    color: #495057;
    text-decoration: underline;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    font-style: italic;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-grid {
        grid-template-columns: 1fr;
    }

    .filter-actions {
        flex-direction: column;
    }

    .data-table {
        font-size: 14px;
    }

    .data-table th,
    .data-table td {
        padding: 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1>Project Report: {{ project.project_name }}</h1>
    </div>

    <!-- Project Summary Section -->
    <div class="report-section">
        <h2>Project Summary</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <span class="label">Project Name:</span>
                <span><a href="{% url 'transactions:project_dashboard' project.project_name %}" class="project-link">
                        {{ project.project_name }}
                    </a></span>
            </div>
            <div class="summary-item full-width">
                <span class="label">Description:</span>
                <span class="value">{{ project.description }}</span>
            </div>
        </div>
    </div>

    <!-- Transaction Analysis Section -->
  <div class="report-section">
        <h2>Transaction Analysis</h2>
        <div class="analysis-container" style="display: flex; gap: 32px; align-items: stretch; flex-wrap: wrap;">
            <div class="stat-item" style="flex: 0 0 275px; display: flex; align-items: center; justify-content: center;">
                <canvas id="transactionChart" width="275" height="275"></canvas>
            </div>
            <div class="analysis-stats" style="display: flex; flex-direction: row; gap: 16px; flex: 1;">
                <div class="stat-item" style="flex: 1 1 0;">
                    <h3>Total Transactions</h3>
                    <div class="stat-value">{{ project.get_total_transactions }}</div>
                    <div class="stat-subvalue">{{ project.get_total_value|floatformat:2 }}</div>
                </div>
                <div class="stat-item supported" style="flex: 1 1 0;">
                    <h3>Supported</h3>
                    <div class="stat-value">{{ project.supported_transactions_number }}</div>
                    <div class="stat-subvalue">{{ project.supported_transactions_value|floatformat:2 }}</div>
                    <div class="stat-percentage">{{ support_percentage|floatformat:1 }}%</div>
                </div>
                <div class="stat-item unsupported" style="flex: 1 1 0;">
                    <h3>Unsupported</h3>
                    <div class="stat-value">{{ project.unsupported_transactions_number }}</div>
                    <div class="stat-subvalue">{{ project.unsupported_transactions_value|floatformat:2 }}</div>
                    <div class="stat-percentage">{{ 100|sub:support_percentage|floatformat:1 }}%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Filters Section -->
    <div class="report-section">
        <div class="filter-section">
            <h3 class="filter-title">Filter Data</h3>
            <form id="filterForm" method="get">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="fiscal_year">Fiscal Year</label>
                        <select name="fiscal_year" id="fiscal_year">
                            <option value="">All Years</option>
                            {% for year in available_years %}
                            <option value="{{ year }}" {% if year == selected_fiscal_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="fiscal_period">Fiscal Period</label>
                        <select name="fiscal_period" id="fiscal_period">
                            <option value="">All Periods</option>
                            {% for period in available_periods %}
                            <option value="{{ period }}" {% if period == selected_fiscal_period %}selected{% endif %}>Period {{ period }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="min_amount">Min Amount (ZMW)</label>
                        <input type="number" name="min_amount" id="min_amount" step="0.01" value="{{ selected_min_amount }}" placeholder="0.00">
                    </div>

                    <div class="filter-group">
                        <label for="max_amount">Max Amount (ZMW)</label>
                        <input type="number" name="max_amount" id="max_amount" step="0.01" value="{{ selected_max_amount }}" placeholder="No limit">
                    </div>

                    <div class="filter-group">
                        <label for="reference_number">Reference Number</label>
                        <input type="text" name="reference_number" id="reference_number" value="{{ selected_reference_number }}" placeholder="Enter reference">
                    </div>

                    <div class="filter-group">
                        <label for="support_status">Support Status</label>
                        <select name="support_status" id="support_status">
                            <option value="">All Status</option>
                            <option value="supported" {% if selected_support_status == 'supported' %}selected{% endif %}>Supported</option>
                            <option value="unsupported" {% if selected_support_status == 'unsupported' %}selected{% endif %}>Unsupported</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions" style="margin-top: 15px;">
                    <button type="submit" class="btn-filter">
                        <span>üîç</span> Apply Filters
                    </button>
                    <a href="{% url 'reports:project_report' project.project_id %}" class="btn-reset">
                        <span>üîÑ</span> Reset
                    </a>
                    <a href="{% url 'reports:project_report_excel' project.project_id %}?{{ request.GET.urlencode }}" class="btn-export">
                        <span>üìä</span> Export to Excel
                    </a>

                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Supporting Documents Section -->
    <div class="report-section">
        <h2>Supporting Documents
            <span style="color: #6c757d; font-size: 0.8em; font-weight: normal;">
                ({{ filtered_documents.count }} of {{ total_documents }} records)
            </span>
        </h2>

        {% if filtered_documents %}
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Batch-Entry</th>
                        <th>Reference Number</th>
                        <th>Fiscal Year</th>
                        <th>Period</th>
                        <th>Transaction Value</th>
                        <th>Support Status</th>
                        <th>Documents</th>
                        <th>Latest Comment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documentsTableBody">
                    {% for doc in filtered_documents %}
                    <tr>
                        <td><strong>{{ doc.batchnbr }}-{{ doc.entrynbr }}</strong></td>
                        <td><code>{{ doc.iddoc|truncatechars:20 }}</code></td>
                        <td>{{ doc.fiscal_year }}</td>
                        <td>{{ doc.fiscal_period }}</td>
                        <td class="amount-cell">ZMW {{ doc.transaction_value|floatformat:2 }}</td>
                        <td>
                            <span class="status-badge {% if doc.supported %}supported{% else %}unsupported{% endif %}">
                                {% if doc.supported %}Supported{% else %}Unsupported{% endif %}
                            </span>
                        </td>
                        <td>
                            <span style="color: #6c757d;">{{ doc.support_count }} file{{ doc.support_count|pluralize }}</span>
                        </td>
                        <td>
                            {% if doc.latest_comment %}
                            <div class="comment-preview" title="{{ doc.latest_comment.text }}">
                                {{ doc.latest_comment.text|truncatechars:50 }}
                                <small style="display: block; color: #adb5bd; font-size: 0.75em;">
                                    by {{ doc.latest_comment.user.get_full_name|default:doc.latest_comment.user.username }}
                                </small>
                            </div>
                            {% else %}
                            <span style="color: #adb5bd; font-style: italic;">No comments</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                {% if doc.documents.exists %}
                                    {% for file in doc.documents.all %}
                                    <a href="{{ file.document.url }}" target="_blank" class="button-secondary" style="font-size: 0.8em; padding: 4px 8px;">
                                        View
                                    </a>
                                    {% endfor %}
                                {% else %}
                                <span style="color: #adb5bd; font-size: 0.8em;">No files</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No supporting documents match the current filters.</p>
            <p>Try adjusting your filter criteria or <a href="{% url 'reports:project_report' project.project_id %}">reset all filters</a>.</p>
        </div>
        {% endif %}
    </div>

    <!-- Enhanced Comments Section -->
    <div class="report-section">
        <h2>Comments History
            <span style="color: #6c757d; font-size: 0.8em; font-weight: normal;">
                ({{ filtered_comments.count }} comments)
            </span>
        </h2>

        {% if filtered_comments %}
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Batch-Entry</th>
                        <th>Author</th>
                        <th>Comment</th>
                        <th>Date</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comment in filtered_comments %}
                    <tr>
                        <td><strong>{{ comment.batchnbr }}-{{ comment.entrynbr }}</strong></td>
                        <td>{{ comment.user.get_full_name|default:comment.user.username }}</td>
                        <td style="max-width: 300px;">{{ comment.text }}</td>
                        <td style="white-space: nowrap;">{{ comment.timestamp|date:"M j, Y g:i a" }}</td>
                        <td><small>{{ comment.source }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No comments match the current filters.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart
    var ctx = document.getElementById('transactionChart').getContext('2d');
    var transactionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ chart_data.labels|safe }},
            datasets: [{
                data: {{ chart_data.data|safe }},
                backgroundColor: [
                    '#4CAF50',
                    '#F44336'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Form submission with loading state
    const filterForm = document.getElementById('filterForm');
    const tableBody = document.getElementById('documentsTableBody');

    filterForm.addEventListener('submit', function(e) {
        // Add loading state
        if (tableBody) {
            tableBody.classList.add('loading');
        }
    });

    // Auto-submit form on certain changes for better UX
    const autoSubmitFields = ['fiscal_year', 'fiscal_period', 'support_status'];
    autoSubmitFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', function() {
                filterForm.submit();
            });
        }
    });

    // Add debounced search for text inputs
    const textInputs = ['reference_number'];
    textInputs.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            let timeout;
            field.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    filterForm.submit();
                }, 500);
            });
        }
    });
});
</script>
{% endblock %}