<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supporting Documents Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .actions-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .report-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-supported {
            background: #d4edda;
            color: #155724;
        }

        .status-unsupported {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Supporting Documents Report Generator</h1>
            <p>Generate comprehensive reports and export to Excel</p>
        </div>

        <div class="filters-section">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">Report Filters</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="projectFilter">Project</label>
                    <select id="projectFilter">
                        <option value="">All Projects</option>
                        <option value="project1">Project Alpha</option>
                        <option value="project2">Project Beta</option>
                        <option value="project3">Project Gamma</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="fiscalYear">Fiscal Year</label>
                    <select id="fiscalYear">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="fiscalPeriod">Fiscal Period</label>
                    <select id="fiscalPeriod">
                        <option value="">All Periods</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="supportedFilter">Support Status</label>
                    <select id="supportedFilter">
                        <option value="">All Status</option>
                        <option value="true">Supported</option>
                        <option value="false">Unsupported</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFrom">Date From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">Date To</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
        </div>

        <div class="actions-bar">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="generateReport()">
                    ðŸ“Š Generate Report
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    ðŸ“Š Export to Excel
                </button>
                <button class="btn btn-info" onclick="exportSummary()">
                    ðŸ“‹ Export Summary
                </button>
            </div>
        </div>

        <div class="stats-cards" id="statsCards">
            <div class="stat-card">
                <h3 id="totalRecords">0</h3>
                <p>Total Records</p>
            </div>
            <div class="stat-card">
                <h3 id="supportedCount">0</h3>
                <p>Supported</p>
            </div>
            <div class="stat-card">
                <h3 id="unsupportedCount">0</h3>
                <p>Unsupported</p>
            </div>
            <div class="stat-card">
                <h3 id="totalValue">$0</h3>
                <p>Total Value</p>
            </div>
        </div>

        <div class="chart-container">
            <h3>Support Status Distribution</h3>
            <canvas id="supportChart" width="400" height="200"></canvas>
        </div>

        <div class="report-table">
            <div class="table-header">
                Supporting Documents Report
            </div>
            <div class="table-container" id="reportContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Click "Generate Report" to view data</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample data structure matching your models
        const sampleData = [
            {
                supporting_docs_id: 1,
                project: 'Project Alpha',
                batchnbr: '004568',
                entrynbr: '00001',
                iddoc: 'EV002703',
                fiscal_year: '2024',
                fiscal_period: '01',
                supported: true,
                transaction_value: 15000.00,
                support_count: 3,
                created_at: '2024-01-15',
                documents: [
                    { document_name: 'Invoice_001.pdf', source: 'System Upload', uploaded_at: '2024-01-15' },
                    { document_name: 'Receipt_001.pdf', source: 'Manual Upload', uploaded_at: '2024-01-16' }
                ],
                comments: [
                    { text: 'All documents verified', user: 'John Doe', timestamp: '2024-01-20' }
                ]
            },
            {
                supporting_docs_id: 2,
                project: 'Project Beta',
                batchnbr: '004569',
                entrynbr: '00002',
                iddoc: 'EV002704',
                fiscal_year: '2024',
                fiscal_period: '02',
                supported: false,
                transaction_value: 8500.00,
                support_count: 1,
                created_at: '2024-02-10',
                documents: [
                    { document_name: 'Invoice_002.pdf', source: 'System Upload', uploaded_at: '2024-02-10' }
                ],
                comments: [
                    { text: 'Missing receipt', user: 'Jane Smith', timestamp: '2024-02-15' }
                ]
            },
            {
                supporting_docs_id: 3,
                project: 'Project Gamma',
                batchnbr: '004570',
                entrynbr: '00003',
                iddoc: 'EV002705',
                fiscal_year: '2024',
                fiscal_period: '01',
                supported: true,
                transaction_value: 22000.00,
                support_count: 4,
                created_at: '2024-01-25',
                documents: [
                    { document_name: 'Contract_001.pdf', source: 'System Upload', uploaded_at: '2024-01-25' },
                    { document_name: 'Amendment_001.pdf', source: 'Manual Upload', uploaded_at: '2024-01-26' }
                ],
                comments: []
            }
        ];

        let currentData = [];
        let supportChart = null;

        function generateReport() {
            const container = document.getElementById('reportContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating report...</p></div>';

            // Simulate API call delay
            setTimeout(() => {
                currentData = filterData();
                renderReport();
                updateStatistics();
                updateChart();
            }, 1000);
        }

        function filterData() {
            let filtered = [...sampleData];

            // Apply filters
            const project = document.getElementById('projectFilter').value;
            const fiscalYear = document.getElementById('fiscalYear').value;
            const fiscalPeriod = document.getElementById('fiscalPeriod').value;
            const supported = document.getElementById('supportedFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (project) {
                filtered = filtered.filter(item => item.project.toLowerCase().includes(project.toLowerCase()));
            }
            if (fiscalYear) {
                filtered = filtered.filter(item => item.fiscal_year === fiscalYear);
            }
            if (fiscalPeriod) {
                filtered = filtered.filter(item => item.fiscal_period === fiscalPeriod);
            }
            if (supported !== '') {
                filtered = filtered.filter(item => item.supported === (supported === 'true'));
            }
            if (dateFrom) {
                filtered = filtered.filter(item => new Date(item.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filtered = filtered.filter(item => new Date(item.created_at) <= new Date(dateTo));
            }

            return filtered;
        }

        function renderReport() {
            const container = document.getElementById('reportContainer');

            if (currentData.length === 0) {
                container.innerHTML = '<div class="no-data">No data found matching your criteria</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Batch #</th>
                            <th>Entry #</th>
                            <th>ID Doc</th>
                            <th>FY</th>
                            <th>Period</th>
                            <th>Status</th>
                            <th>Value</th>
                            <th>Doc Count</th>
                            <th>Support Count</th>
                            <th>Comments</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentData.map(item => `
                            <tr>
                                <td>${item.project}</td>
                                <td>${item.batchnbr}</td>
                                <td>${item.entrynbr}</td>
                                <td>${item.iddoc}</td>
                                <td>${item.fiscal_year}</td>
                                <td>${item.fiscal_period}</td>
                                <td>
                                    <span class="status-badge ${item.supported ? 'status-supported' : 'status-unsupported'}">
                                        ${item.supported ? 'Supported' : 'Unsupported'}
                                    </span>
                                </td>
                                <td>$${item.transaction_value.toLocaleString()}</td>
                                <td>${item.documents.length}</td>
                                <td>${item.support_count}</td>
                                <td>${item.comments.length}</td>
                                <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function updateStatistics() {
            const totalRecords = currentData.length;
            const supportedCount = currentData.filter(item => item.supported).length;
            const unsupportedCount = totalRecords - supportedCount;
            const totalValue = currentData.reduce((sum, item) => sum + item.transaction_value, 0);

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('supportedCount').textContent = supportedCount;
            document.getElementById('unsupportedCount').textContent = unsupportedCount;
            document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
        }

        function updateChart() {
            const supportedCount = currentData.filter(item => item.supported).length;
            const unsupportedCount = currentData.length - supportedCount;

            const ctx = document.getElementById('supportChart').getContext('2d');

            if (supportChart) {
                supportChart.destroy();
            }

            supportChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Supported', 'Unsupported'],
                    datasets: [{
                        data: [supportedCount, unsupportedCount],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function exportToExcel() {
            if (currentData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            // Prepare data for Excel export
            const excelData = currentData.map(item => ({
                'Project': item.project,
                'Batch Number': item.batchnbr,
                'Entry Number': item.entrynbr,
                'ID Document': item.iddoc,
                'Fiscal Year': item.fiscal_year,
                'Fiscal Period': item.fiscal_period,
                'Supported': item.supported ? 'Yes' : 'No',
                'Transaction Value': item.transaction_value,
                'Support Count': item.support_count,
                'Document Count': item.documents.length,
                'Comment Count': item.comments.length,
                'Created Date': item.created_at,
                'Documents': item.documents.map(doc => doc.document_name).join('; '),
                'Comments': item.comments.map(comment => `${comment.user}: ${comment.text}`).join('; ')
            }));

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Add the worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Supporting Documents');

            // Add summary sheet
            const summaryData = [
                ['Total Records', currentData.length],
                ['Supported Records', currentData.filter(item => item.supported).length],
                ['Unsupported Records', currentData.filter(item => !item.supported).length],
                ['Total Value', currentData.reduce((sum, item) => sum + item.transaction_value, 0)],
                ['Generated On', new Date().toLocaleString()]
            ];

            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');

            // Save the file
            const fileName = `supporting_documents_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportSummary() {
            if (currentData.length === 0) {
                alert('Please generate a report first');
                return;
            }

            // Create summary by project
            const projectSummary = {};
            currentData.forEach(item => {
                if (!projectSummary[item.project]) {
                    projectSummary[item.project] = {
                        project: item.project,
                        totalRecords: 0,
                        supportedRecords: 0,
                        totalValue: 0,
                        documentCount: 0
                    };
                }
                projectSummary[item.project].totalRecords++;
                if (item.supported) projectSummary[item.project].supportedRecords++;
                projectSummary[item.project].totalValue += item.transaction_value;
                projectSummary[item.project].documentCount += item.documents.length;
            });

            const summaryArray = Object.values(projectSummary).map(proj => ({
                'Project': proj.project,
                'Total Records': proj.totalRecords,
                'Supported Records': proj.supportedRecords,
                'Support Percentage': ((proj.supportedRecords / proj.totalRecords) * 100).toFixed(1) + '%',
                'Total Value': proj.totalValue,
                'Total Documents': proj.documentCount
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(summaryArray);
            XLSX.utils.book_append_sheet(wb, ws, 'Project Summary');

            const fileName = `project_summary_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];

            // Auto-generate initial report
            generateReport();
        });
    </script>
</body>
</html>