{% load file_tags %}
{% for item in transactions_with_docs %}
<!-- Simplified Document Modal -->
<div class="modal fade" id="viewFileModal{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}" tabindex="-1" aria-labelledby="viewFileModalLabel{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewFileModalLabel{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}">Documents for Batch-Entry #{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <!-- Document List Section -->
        <div class="mb-4">
         <h6 class="border-bottom pb-2 mb-3">Existing Documents</h6>
        {% if item.docs %}
          <ul class="list-group">
            {% for doc in item.docs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ doc.document_name|default:doc.document.name }}</span>

                  <div>
                    {% get_file_url doc as file_url %}
                    <a href="{{ file_url }}" class="btn btn-sm btn-primary" target="_blank">
                      <i class="bi bi-eye"></i> Open
                    </a>

                    {% if doc.source != 'SQL Server Reference' %}
                      <a href="{% url 'transactions:delete_transaction_file' doc.doc_file_id %}" id="delete-button-{{ doc.doc_file_id }}" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Are you sure you want to delete this document?');">
                        <i class="bi bi-trash"></i> Delete
                      </a>
                    {% endif %}
                  </div>
                </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No documents attached to this transaction.</p>
        {% endif %}
        </div>

        <!-- Upload Section -->
        <div id="upload-div">
          <h6 class="border-bottom pb-2 mb-3">Upload Additional Document</h6>
          <form method="post"
                action="{% url 'transactions:upload_file' item.transaction.batchnbr item.transaction.entrynbr project_name %}"
                data-project-name="{{ project_name }}"
                id="additional-upload-form-{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}"
                enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
              <label for="additional-document-{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}">Upload file:</label>
              <input type="file" name="file" id="additional-document-{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}" data-reference="{{ transaction.jnldtlref }}" required>
              <div id="additional-upload-status-{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}"></div>
            </div>
            <button type="submit" id="document-upload-additional-button-{{ item.transaction.batchnbr }}-{{ item.transaction.entrynbr }}" class="btn btn-primary">Upload</button>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}